Документация к модулю "Эксперимент"
====================================


Общая информация
-----------------

Модуль проведения эксперимента запускается по адресу ``109.234.34.140`` с порта ``5001`` и принимает запросы около десятка видов (каждый вид соответствует конкретному действию на томографе, например *включение/выключение источника излучения*,  *открытие заслонки*  и т.д.). Все URI по которым  принимаются запросы имеют вид ``http://109.234.34.140:5001/tomograph/<номер томографа>/<часть адреса, соответствующая конкретному действию>``.

Пример (функция, включающая источник излучения первого томографа): ``http://109.234.34.140:5001/tomograph/1/source/power-on``. 

**Пока есть только один томограф и он стоит под номером 1, поэтому ниже везде в URI вместо номера томографа будет стоять 1.** 

Список всех действий написан в разделе  `Действия`_ .

Формат запросов и ответов
--------------------------
Модуль принимает запросы типа **GET** и **POST**. **POST** запросы принимают функции  `Установить новые значения тока и напряжения`_ ,  `Подвинуть объект`_ ,  `Начать эксперимент`_ , при этом в теле запроса должна быть **JSON-строка** (нужный формат описан в разделе самих функций).  **Здесь и далее под словом формат запроса/ответа будет подразумеваться формат не самой JSON-строки, а формат python-словаря, соответсвующего этой строке.**  Ответ на любой запрос имеет формат:
	.. code-block:: python

		{
			'success': <boolean; True, если всё прошло успешно и False, если нет>,
			'error': <str; общее название ошибки, если значение 'success' было False, иначе пустая строка>,
			'exception message': <str; сообщение исключения для более подробного описания проблемы, если 'success' было False, не всегда что-то написано>
		}
**Единственный случай ответа с другим форматом выдаётся функцией** `Снять изображение`_ **!**


`Действия`
-----------

Список всех действий:

* `Включение/выключение`_
	* `Включить источник рентгеновского излучения`_
	* `Выключить источник рентгеновского излучения`_
* `Элементы юстировки`_
	* `Открыть заслонку`_
	* `Закрыть заслонку`_
	* `Установить новые значения тока и напряжения`_
	* `Подвинуть объект`_
	* `Снять изображение`_
* `Эксперимент`_
	* `Начать эксперимент`_
	* `Остановить эксперимент`_


`Включение/выключение`
~~~~~~~~~~~~~~~~~~~~~~~
	
`Включить источник рентгеновского излучения`
"""""""""""""""""""""""""""""""""""""""""""""
**URI:**  ``http://109.234.34.140:5001/tomograph/1/source/power-on``

**Тип запроса:**  GET

**Описание:**  Включает источник рентгеновского излучения(кэп)
	

`Выключить источник рентгеновского излучения`
""""""""""""""""""""""""""""""""""""""""""""""
**URI:**  ``http://109.234.34.140:5001/tomograph/1/source/power-off``

**Тип запроса:**  GET

**Описание:**  Выключает источник рентгеновского излучения




`Элементы юстировки`
~~~~~~~~~~~~~~~~~~~~~~
	
`Открыть заслонку`
""""""""""""""""""""""""""""""""""""""""""""
**URI:**  ``http://109.234.34.140:5001/tomograph/1/shutter/open/<int, время в секундах t>``

**Тип запроса:**  GET

**Описание:**  Открывает заслонку на **t** секунд, кроме случая **t** равное 0, тогда заслонка будет стоять открытой, пока её явно не закроют функцией `Закрыть заслонку`_.



`Закрыть заслонку`
""""""""""""""""""""""""""""""""""""""""""""
**URI:**  ``http://109.234.34.140:5001/tomograph/1/shutter/close/<int, время в секундах t>``

**Тип запроса:**  GET

**Описание:**  Закрывает заслонку на **t** секунд, кроме случая **t** равное 0, тогда заслонка будет стоять закрытой, пока её явно не закроют функцией `Открыть заслонку`_.


`Установить новые значения тока и напряжения`
"""""""""""""""""""""""""""""""""""""""""""""
**URI:**  ``http://109.234.34.140:5001/tomograph/1/source/set-operating-mode>``

**Тип запроса:**  POST

**Формат запроса:**
	.. code-block:: python

		{
		    'voltage': <float; новое значение напряжения>,
		    'current': <float; новое значение тока>,
		}

**Описание:**  Устанавливает новые значения тока(в мА) и напряжения (в кВ). **Значения округляются до десятых долей!** Например, если придёт значение 5.778 кВ, то оно округлится до значения 5.8 кВ.

**Допустимые значения**:  Напряжение - от 2 до 60 кВ, ток - от 2 до 80 мА.


`Подвинуть объект`
""""""""""""""""""""

TODO

`Снять изображение`
""""""""""""""""""""""""""""""""""""""""""""
**URI:**  ``http://109.234.34.140:5001/tomograph/1/detector/get-frame/<float, экспозиция в миллисекундах t>``

**Тип запроса:**  GET

**Описание:**  Снимает изображение с экспозицией в **t** миллисекунд. **Значение  округляются до десятых долей!** Например, если придёт значение 5.778 мс, то оно округлится до значения 5.8 мс.

**Формат ответа:**
	.. code-block:: python

		{
			'success': <boolean; True, если всё прошло успешно и False, если нет>,
			'image': <dict; изображение вместе с метаданными, которые приходят с томографа>
				{
				  "image_data":
						{
						  "image": само изображение
						  "exposure": время экспозиции
						  "datetime": дата и время получения изображения в формате dd.mm.yyyy hh:mm:ss
						  "detector":
								{
								  "model": модель детектора
								}
						}
				  "object":
						{
						  "angle position": угол поворота объекта
						}
				  "shutter":
						{
						  "open": True, если заслонка открыта и False иначе
						}

				  "X-ray source":
						{
						  "voltage": напряжение
						  "current": ток
						}
				}
		}








`Эксперимент`
~~~~~~~~~~~~~

`Начать эксперимент`
""""""""""""""""""""""
**URI:**  ``http://109.234.34.140:5001/tomograph/1/experiment/begin``

**Тип запроса:**  POST

**Формат запроса:**  Зависит от типа эксперимента (продвинутй или непродвинутый). В поле 'experiment parameters' должно быть подполе 'advanced', которое определяет "продвинутость" эксперимента. Если оно False, то формат должен иметь вид: 
	.. code-block:: python

		{
		    'experiment id': <str; идентфикатор эксперимента, пример: '553e898c6c8dc562738e925a'>,
		    'for storage':
		        {
					'нужно': 'дописать',
		        },
		    'experiment parameters':
		        {
		            'advanced': <boolean; "продвинутость" эксперимента, В ДАННОМ СЛУЧАЕ False>,
		            'DARK':
		                {
		                    'count': <int; кол-во DARK изображений>,
		                    'exposure': <float; экспозиция, с которой снимаются DARK изображения>,
		                },
		            'EMPTY':
		                {
		                    'count': <int; кол-во EMPTY изображений>,
		                    'exposure': <float; экспозиция, с которой снимаются EMPTY изображения>,
		                },
		            'DATA':
		                {
		                    'count': <int; кол-во EMPTY изображений>,
		                    'exposure': <float; экспозиция, с которой снимаются EMPTY изображения>

		                    'step count':  <int; кол-во "положений", при одном "положении" изображения снимаются при конкретном положении движка>,
		                    'exposure':  <float; экспозиция, с которой снимаются DATA изображения>,
		                    'angle step': <float; "угловой шаг", угловое расстояние между двумя "положениями">,
		                    'count per step': <int; кол-во DATA изображений, при одном "положении">
		                }
		        },
		}
или
	.. code-block:: python

		{
		    'experiment id': <str; идентфикатор эксперимента, пример: '553e898c6c8dc562738e925a'>,
		    'for storage':
		        {
					'нужно': 'дописать',
		        },
		    'experiment parameters':
				{
		            'advanced': <boolean; "продвинутость" эксперимента, В ДАННОМ СЛУЧАЕ True>,
					'instruction': <list; список комманд, для последовательного исполнения на томографе>
						[
						    {'type': 'open shutter', 'args': 0},
						    {'type': 'get frame', 'args': 3.5},
						    {'type': 'go to position', 'args': [0, 0, -1.495]},
						    {'type': 'close shutter', 'args': 0},
						    {'type': 'reset current position', 'args': None},
						    {'type': 'get frame', 'args': 0.5},
						]
		    	},
		}

**Описание:**  Потом напишем...


`Остановить эксперимент`
"""""""""""""""""""""""""
**URI:**  ``http://109.234.34.140:5001/tomograph/1/experiment/stop``

**Тип запроса:**  GET

**Описание:**  Останавливает текущий эксперимент
